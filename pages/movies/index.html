<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Catalog</title>
  <link rel="icon" type="image/gif" href="https://gp-site.github.io/gp/img/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #000;
      --panel: #0e0f13;
      --inner: #13141a;
      --chip: #222428;
      --chip-2: #2b2e33;
      --text: #ccc;
      --text-strong: #fff;
      --accent: #fff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 80px;
      background: var(--panel);
      border-radius: 20px;
      margin: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      padding: 10px 0 14px;
      gap: 6px;
    }
    .circle-btn {
      width: 45px; height: 45px;
      background: var(--chip);
      border-radius: 50%;
      margin: 6px 0;
      display: flex; justify-content: center; align-items: center;
      color: #fff; font-size: 18px; cursor: pointer; position: relative;
      transition: transform .15s ease, background .15s ease;
      overflow: visible;
      border: none;
    }
    .circle-btn:hover { background: var(--chip-2); transform: translateY(-1px); }
    .circle-btn:active { transform: translateY(0); }
    .circle-btn input {
      position: absolute; left: 55px; top: 50%; transform: translateY(-50%);
      width: 0; opacity: 0; height: 28px; border: none; outline: none;
      padding: 0 10px; border-radius: 10px; background: var(--chip-2); color: #fff;
      transition: width .2s ease, opacity .2s ease;
    }
    .circle-btn.active input { width: 210px; opacity: 1; }
    .filter-menu {
      position: absolute; top: 0; left: 55px;
      background: var(--chip); border-radius: 10px; padding: 0;
      display: flex; flex-wrap: wrap; gap: 6px; max-width: 230px;
      max-height: 0; overflow: hidden; opacity: 0; pointer-events: none;
      transition: max-height .2s ease, opacity .2s ease, padding .2s ease;
      z-index: 2;
    }
    .circle-btn.active .filter-menu { max-height: 420px; opacity: 1; padding: 10px; pointer-events: auto; }
    .filter-menu button {
      background: var(--chip-2); color: #fff; border: none; padding: 6px 8px; border-radius: 6px;
      white-space: nowrap; cursor: pointer; text-align: left; font-size: 12px;
    }
    .filter-menu button:hover { background: #1b1d23; }
    .scrollbar { flex: 1; width: 100%; display: flex; justify-content: center; position: relative; }
    .track {
      position: absolute; top: 10px; bottom: 10px; width: 10px; border-radius: 5px; background: var(--chip);
    }
    .thumb {
      position: absolute; left: 50%; transform: translateX(-50%);
      width: 55px; height: 35px; background: var(--chip);
      border-radius: 10px; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center;
      box-shadow: 0 1px 0 rgba(255,255,255,.06) inset;
    }
    .thumb:active { cursor: grabbing; }
    .thumb div { width: 38%; height: 3px; background: var(--accent); margin: 2px 0; border-radius: 2px; opacity: .8; }
    .catalog-frame { flex: 1; margin: 20px; border-radius: 20px; background: var(--panel); padding: 15px; display: flex; flex-direction: column; }
    .catalog-inner { flex: 1; border-radius: 15px; background: var(--inner); padding: 15px; overflow-y: auto; scrollbar-width: none; }
    .catalog-inner::-webkit-scrollbar { display: none; }
    .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 18px; }
    .movie-card {
      background: var(--chip); border-radius: 14px; padding: 8px; text-align: center; cursor: pointer; transition: transform .12s ease, background .12s ease;
    }
    .movie-card:hover { transform: translateY(-2px); background: var(--chip-2); }
    .movie-card h3 { font-size: 13px; margin: 6px 0 6px; color: var(--text-strong); line-height: 1.2; }
    .movie-card img { width: 100%; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 10px; background: #444; }
    .movie-card p { font-size: 11px; color: var(--text-strong); margin: 6px 0 0; opacity: .9; }
    .movie-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.9);
      display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; padding: 20px;
    }
    .movie-overlay.active { display: flex; }
    .movie-overlay .video-wrap { position: relative; width: 84vw; max-width: 1400px; }
    .movie-overlay video {
      width: 100%; height: 78vh; max-height: 78vh; display: block; border-radius: 12px; background: #000; outline: none; border: none;
    }
    .overlay-controls { margin-top: 10px; display: flex; gap: 10px; }
    .overlay-controls button {
      background: var(--chip); color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 14px;
    }
    .overlay-controls button:hover { background: var(--chip-2); }
    .notice { font-size: 13px; opacity: .8; text-align: center; margin: 8px 0 0; }
    .status { font-size: 12px; opacity: .8; margin: 10px 0; }
    a.inline { color:#fff; text-decoration: underline; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" aria-label="Sidebar controls">
    <button class="circle-btn" id="searchBtn" aria-label="Toggle search">
      <i class="fa fa-search" aria-hidden="true"></i>
      <input type="text" id="searchInput" placeholder="Search..." aria-label="Search movies" />
    </button>
    <button class="circle-btn" id="filterBtn" aria-label="Toggle filters">
      <i class="fa fa-filter" aria-hidden="true"></i>
      <div class="filter-menu" id="filterMenu" role="menu" aria-label="Filter by genre"></div>
    </button>
    <div class="scrollbar" aria-hidden="true">
      <div class="track"></div>
      <div class="thumb"><div></div><div></div><div></div></div>
    </div>
    <a class="circle-btn" id="homeBtn" href="../../index.html" aria-label="Home">
      <i class="fa fa-home" aria-hidden="true"></i>
    </a>
  </div>
  <!-- Catalog -->
  <div class="catalog-frame">
    <div class="status" id="status"></div>
    <div class="catalog-inner" id="movieCatalog">
      <div class="movie-grid" id="movieGrid"></div>
    </div>
  </div>
  <!-- Overlay -->
  <div class="movie-overlay" id="movieOverlay" aria-modal="true" role="dialog">
    <div class="video-wrap">
      <div id="movieContainer"></div>
    </div>
    <div class="overlay-controls">
      <button id="fsBtn" type="button">Fullscreen</button>
      <button id="closeBtn" type="button">Close</button>
    </div>
  </div>
<script>
/*************************
 * CONFIG
 *************************/
const SHEET_URL = "https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/testmovies?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M";

const OMDB_API_KEYS = [
  "cda9cc2e",
  "41fd826a",
  "bb742de8",
  "c6a43a55"
];

/*************************
 * ELEMENTS
 *************************/
const catalog      = document.getElementById("movieCatalog");
const movieGrid    = document.getElementById("movieGrid");
const statusEl     = document.getElementById("status");
const track        = document.querySelector(".track");
const thumb        = document.querySelector(".thumb");
const searchBtn    = document.getElementById("searchBtn");
const searchInput  = document.getElementById("searchInput");
const filterBtn    = document.getElementById("filterBtn");
const filterMenu   = document.getElementById("filterMenu");
const overlay      = document.getElementById("movieOverlay");
const movieContainer = document.getElementById("movieContainer");
const fsBtn        = document.getElementById("fsBtn");
const closeBtn     = document.getElementById("closeBtn");

/*************************
 * STATE
 *************************/
let ALL_MOVIES = [];
let GENRES = new Set();

/*************************
 * UTILITIES
 *************************/

 function getRandomOmdbKey() {
  return OMDB_API_KEYS[Math.floor(Math.random() * OMDB_API_KEYS.length)];
}

const byId = (id) => document.getElementById(id);
const isVttUrl = (s) => typeof s === 'string' && /\.vtt($|\?)/i.test(s);
const extractImdb = (s) => {
  if (!s) return '';
  const m = String(s).match(/tt\d{5,10}/i);
  return m ? m[0] : '';
};
const titleFromUrl = (url) => {
  try {
    const u = new URL(url);
    const last = u.pathname.split('/').filter(Boolean).pop() || '';
    const raw = last.replace(/[-_.]/g, ' ').replace(/\s+/g, ' ').trim();
    if (!raw) return 'Untitled';
    return raw.replace(/\b\w/g, c => c.toUpperCase());
  } catch { return 'Untitled'; }
};
function getDateString() {
  const d = new Date();
  const fmt = (dt) => dt.toISOString().split('T')[0].replace(/-/g, '');
  const y = new Date(d); y.setDate(d.getDate() - 1);
  const t = new Date(d); t.setDate(d.getDate() + 1);
  return fmt(y) + fmt(d) + fmt(t);
}
function buildFinalUrls(baseURL, imdbID, subsUrlMaybe) {
  const longDate = getDateString();
  const videoUrl = baseURL ? String(baseURL) + longDate : '';
  let subsUrl = '';
  if (isVttUrl(subsUrlMaybe)) subsUrl = subsUrlMaybe;
  else if (imdbID) subsUrl = `https://rips.cc/subs/${imdbID}.vtt`;
  return { videoUrl, subsUrl };
}
function idx(headers, name) {
  const target = String(name).toLowerCase();
  for (let i = 0; i < headers.length; i++) {
    if (String(headers[i]).toLowerCase().trim() === target) return i;
  }
  return -1;
}

/*************************
 * DATA FETCH + NORMALIZE
 *************************/
async function fetchMovieData() {
  statusEl.textContent = 'Loading moviesâ€¦';
  try {
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    const rows = json && Array.isArray(json.values) ? json.values : [];
    if (!rows.length) {
      statusEl.textContent = 'No rows returned from the Google Sheet.';
      return;
    }

    const headers = rows.shift().map(h => String(h).trim());

    // Helper to accept common header variants
    const idxAny = (names) => {
      for (const n of names) {
        const i = idx(headers, n);
        if (i !== -1) return i;
      }
      return -1;
    };

    const URL_I   = idxAny(['url']);
    const IMDB_I  = idxAny(['omdb id', 'imdb id', 'imdbid', 'imdb']);
    const TTL_I   = idxAny(['title']);
    const GEN_I   = idxAny(['genre', 'genres']);
    const YEAR_I  = idxAny(['year', 'release year']);
    const DIR_I   = idxAny(['director']);
    const ACT_I   = idxAny(['actors', 'cast']);
    const PLOT_I  = idxAny(['plot', 'overview', 'description']);
    const PST_I   = idxAny(['poster', 'image', 'art']);

    const placeholderPoster = 'https://placehold.co/300x450/transparent/F00/?text=Database+Error';

    ALL_MOVIES = rows.map((r) => {
      const baseURL = URL_I !== -1 ? (r[URL_I] || '') : '';
      const rawImdb = IMDB_I !== -1 ? (r[IMDB_I] || '') : '';
      const imdbID = extractImdb(rawImdb);

      const title = (TTL_I !== -1 ? (r[TTL_I] || '') : '') || titleFromUrl(baseURL);
      const overview = PLOT_I !== -1 ? (r[PLOT_I] || '') : '';
      const poster = (PST_I !== -1 ? (r[PST_I] || '') : '') || placeholderPoster;

      const genres =
        GEN_I !== -1 && r[GEN_I]
          ? String(r[GEN_I]).split(',').map(s => s.trim()).filter(Boolean)
          : ['Unknown'];

      const year = YEAR_I !== -1 ? (r[YEAR_I] || '') : '';
      const director = DIR_I !== -1 ? (r[DIR_I] || '') : '';
      const actors = ACT_I !== -1 ? (r[ACT_I] || '') : '';

      // No explicit subtitles column now; build from imdbID if present
      const { videoUrl, subsUrl } = buildFinalUrls(baseURL, imdbID, '');

      return { title, overview, poster, genres, year, director, actors, baseURL, imdbID, videoUrl, subsUrl };
    });

    // Build genre set
    GENRES = new Set();
    ALL_MOVIES.forEach(m => m.genres.forEach(g => GENRES.add(g)));
    buildFilters();
    renderMovies(ALL_MOVIES);
    statusEl.textContent = '';
    updateThumb();
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Failed to load from Google Sheets. Check API key, sharing settings, and range name.';
  }
}

// OMDb enrichment disabled: metadata now comes entirely from Google Sheets.
async function enrichFromOMDb(movie, cardEl) {
  // No-op: we now source Title, Plot, Poster, Genre, etc. from the sheet.
  // Left in place to avoid touching the rest of the rendering pipeline.
  return;
}

/*************************
 * RENDER
 *************************/
function renderMovies(list) {
  movieGrid.innerHTML = '';
  if (!list.length) {
    movieGrid.innerHTML = `<p class="notice">No movies match your filters.</p>`;
    return;
  }
  const frag = document.createDocumentFragment();
  for (const movie of list) {
    const card = document.createElement('div');
    card.className = 'movie-card';

    const titleHtml = movie.imdbID
      ? `<a class="inline" href="https://www.imdb.com/title/${movie.imdbID}/" target="_blank" rel="noopener">${escapeHtml(movie.title)}</a>`
      : escapeHtml(movie.title);

    const genresHtml = movie.genres.map(g => `<span>${escapeHtml(g)}</span>`).join(', ');

    card.innerHTML = `
      <h3>${titleHtml}</h3>
      <img src="${movie.poster}" alt="${escapeHtml(movie.title)} poster" onerror="this.src='https://placehold.co/300x450/transparent/F00/?text=Database+Error'">
      <p>${genresHtml}</p>
    `;
    card.addEventListener('click', () => openOverlay(movie));
    frag.appendChild(card);

    // Previously enriched from OMDb; now a no-op.
    enrichFromOMDb(movie, card);
  }
  movieGrid.appendChild(frag);
}

function buildFilters() {
  filterMenu.innerHTML = '';
  const addBtn = (label, handler) => {
    const b = document.createElement('button');
    b.textContent = label; b.type = 'button'; b.addEventListener('click', handler);
    filterMenu.appendChild(b);
  };
  addBtn('All', () => renderMovies(ALL_MOVIES));
  [...GENRES].sort().forEach(cat => addBtn(cat, () => renderMovies(ALL_MOVIES.filter(m => m.genres.includes(cat)))));
}

/*************************
 * OVERLAY PLAYER
 *************************/
function openOverlay(movie) {
  const hasVideo = Boolean(movie.videoUrl);
  const videoEl = document.createElement('video');
  videoEl.id = 'videoplayer';
  videoEl.controls = true;
  videoEl.playsInline = true;
  videoEl.setAttribute('webkit-playsinline', '');
  videoEl.setAttribute('controlsList', 'nodownload');
  if (hasVideo) {
    const src = document.createElement('source');
    src.id = 'vidsource';
    src.src = movie.videoUrl;
    src.type = 'video/mp4';
    videoEl.appendChild(src);
  }
  if (movie.subsUrl) {
    const tr = document.createElement('track');
    tr.id = 'subs';
    tr.kind = 'subtitles';
    tr.src = movie.subsUrl;
    tr.srclang = 'en';
    tr.default = true;
    videoEl.appendChild(tr);
  }
  const meta = document.createElement('div');
  meta.innerHTML = `
    <h2 style="text-align:center;margin:10px 0 6px;">${escapeHtml(movie.title)}</h2>
    ${movie.overview ? `<p style="max-width:84ch;margin:0 auto;text-align:center;white-space:normal;">${escapeHtml(movie.overview)}</p>` : ''}
  `;
  movieContainer.innerHTML = '';
  movieContainer.appendChild(videoEl);
  movieContainer.appendChild(meta);
  overlay.classList.add('active');
  overlay.addEventListener('click', overlayClickClose);
}
function overlayClickClose(e) {
  const wrap = e.target.closest('.video-wrap');
  const isControls = e.target.closest('.overlay-controls');
  if (!wrap && !isControls) closeOverlay();
}
function closeOverlay() {
  overlay.classList.remove('active');
  movieContainer.innerHTML = '';
  overlay.removeEventListener('click', overlayClickClose);
}
function toggleFullscreen() {
  const el = document.getElementById('videoplayer');
  if (!el) return;
  const isFs = document.fullscreenElement || document.webkitFullscreenElement;
  if (!isFs) {
    (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen)?.call(el);
  } else {
    (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen)?.call(document);
  }
}

/*************************
 * CUSTOM SCROLLBAR SYNC
 *************************/
function updateThumb() {
  const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
  const trackHeight = track.clientHeight - thumb.clientHeight;
  thumb.style.top = ratio * trackHeight + "px";
}
function onCatalogScroll() { updateThumb(); }
let dragging = false, startY = 0, startTop = 0;
thumb.addEventListener('mousedown', (e) => {
  dragging = true; startY = e.clientY; startTop = parseInt(thumb.style.top || '0', 10) - track.offsetTop; thumb.style.cursor = 'grabbing';
  e.preventDefault();
});
document.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  const trackHeight = track.clientHeight;
  const thumbHeight = thumb.clientHeight;
  const maxTop = trackHeight - thumbHeight;
  let newTop = Math.min(maxTop, Math.max(0, startTop + (e.clientY - startY)));
  thumb.style.top = (track.offsetTop + newTop) + 'px';
  const scrollable = catalog.scrollHeight - catalog.clientHeight;
  catalog.scrollTop = (newTop / maxTop) * scrollable;
});
document.addEventListener('mouseup', () => { dragging = false; thumb.style.cursor = 'grab'; });

/*************************
 * SEARCH + FILTER UI
 *************************/
searchBtn.addEventListener('click', () => {
  searchBtn.classList.toggle('active');
  if (searchBtn.classList.contains('active')) {
    setTimeout(() => searchInput.focus(), 0);
  } else {
    searchInput.value = '';
    renderMovies(ALL_MOVIES);
  }
});
searchInput.addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = ALL_MOVIES.filter(m => m.title.toLowerCase().includes(term));
  renderMovies(filtered);
});
filterBtn.addEventListener('click', () => {
  filterBtn.classList.toggle('active');
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && overlay.classList.contains('active')) closeOverlay();
});
fsBtn.addEventListener('click', toggleFullscreen);
closeBtn.addEventListener('click', closeOverlay);
catalog.addEventListener('scroll', onCatalogScroll);
window.addEventListener('resize', updateThumb);

/*************************
 * HELPERS
 *************************/
function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

/*************************
 * INIT
 *************************/
fetchMovieData();
</script>
</body>
</html>